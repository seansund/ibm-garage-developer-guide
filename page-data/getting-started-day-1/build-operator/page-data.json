{"componentChunkName":"component---src-pages-getting-started-day-1-build-operator-index-mdx","path":"/getting-started-day-1/build-operator/","result":{"pageContext":{"frontmatter":{"title":"(Advanced) Building an operator"},"relativePagePath":"/getting-started-day-1/build-operator/index.mdx","titleType":"page","MdxNode":{"id":"6680b8ea-eab5-531f-b197-3ca990a732d1","children":[],"parent":"a9168bb7-809d-5fc8-a74e-557bc04f69c2","internal":{"content":"---\ntitle: (Advanced) Building an operator\n---\n\nimport Globals from 'gatsby-theme-carbon/src/templates/Globals';\n\n<PageDescription>\n\nSet up DevOps pipelines to build an operator and operator catalog\n\n</PageDescription>\n\nThe <Globals name=\"shortName\" /> provides Tekton pipelines to automate the process to build and deploy operator-based\napplications. The operator pipeline supports Ansible, Go, and Helm-based operators that have been built using the Operator SDK.\nThe <Globals name=\"shortName\" /> also provides a companion Tekton pipeline to build a custom Operator Lifecycle Manager catalog\nthat simplifies deployment of the operators to a cluster.\n\nThe following steps will walk you through using the pipelines to build an operator and operator catalog and deploy them\nto a cluster.\n\n## Prerequisites\n\n### Operator SDK\n\nThe Tekton pipeline for building operators requires that the operator has been created by at least v1.0.0 of the <a href=\"https://sdk.operatorframework.io/docs/\" target=\"_blank\">Operator SDK</a>\nbut we recommend using the latest available (v1.3.0 at the time of this writing). The Operator SDK structure had a major\narchitectural change with v1.0.0 and continues to have significant improvements made with each release.\n\nIf you do not have `operator-sdk`, follow the [installation instructions](https://sdk.operatorframework.io/docs/installation/) to\nget it.\n\n## (Optional) Create your operator\n\nThese steps will walk you through building a simple operator following the Operator SDK quick-start guide. You can choose\nbetween <a href=\"https://sdk.operatorframework.io/docs/building-operators/ansible/quickstart/\" target=\"_blank\">Ansible</a>\n<a href=\"https://sdk.operatorframework.io/docs/building-operators/golang/quickstart/\" target=\"_blank\">Go</a>, or\n<a href=\"https://sdk.operatorframework.io/docs/building-operators/helm/quickstart/\" target=\"_blank\">Helm</a> quick start guides\nfor the following example.\n\n<InlineNotification>\n\n**Note:** If you already have an operator built with v1.0.0+ of the Operator SDK then you can skip to the next section.\n\n</InlineNotification>\n\nThe `Ansible` operator quick start seems to be the simplest way to get up and running quickly and exercise the Tekton\npipelines. We've included the abbreviated steps from the <a href=\"https://sdk.operatorframework.io/docs/building-operators/ansible/quickstart/\" target=\"_blank\">Ansible</a>\nquick start guide below.\n\n1. Create a directory for your operator and change to that directory\n\n    ```shell\n    mkdir memcached-operator\n    cd memcached-operator\n    ```\n1. Initialize the operator\n\n    ```shell\n    operator-sdk init --plugins=ansible --domain=example.com\n    ```\n\n    where:\n    - `--plugins` can be either `ansible`, `go`, or `helm`. If `--plugins` is not provided then it defaults to `go`\n    - `--domain` is the base domain name used for the Custom Resource Definition generated for the operator\n1. Create an API for the operator\n    ```shell\n    operator-sdk create api --group cache --version v1 --kind Memcached --generate-role\n    ```\n\n    where:\n    - `--group` is the api group for the CRD\n    - `--kind` is the resource kind for the CRD\n    - `--version` is the resource version for the CRD\n1. Generate metadata for Operator bundle\n    ```shell\n    make bundle\n    ```\n    Answer the interactive questions\n1. Create the README.md and initialize git repository\n    ```shell\n    echo \"# memcached operator\" > README.md\n    git init\n    git add .\n    git commit -m \"Initial commit\"\n    ```\n1. Create a new remote git repository on a git server such as GitHub and copy the url\n1. Push the local git repository to the remote GitHub repository\n    ```shell\n    git remote add origin ${GIT_URL}\n    git push -u origin $(git rev-parse --abbrev-ref HEAD)\n    ```\n\nAt this point you have enough of a functioning operator to try out the Tekton operator pipeline. If you want to explore\nthe operator you have created and/or enhance its capabilities, there are more detailed instructions on the [operator sdk](https://sdk.operatorframework.io/docs/building-operators/)\npage.\n\n## Register the operator pipeline\n\nThis step is similar to [deploying an application](../deploy-app).\n\n### 1. Log into your Development Cluster from the command line\n\nBefore starting, make sure you have set up your [development tools](/getting-started/dev-env-setup).\n\n<Tabs>\n<Tab label=\"Cluster managed by IBM Cloud\">\n\nLog into the cluster with `icc [cluster name|cluster nickname]`\n\n</Tab>\n<Tab label=\"OpenShift cluster\">\n\nRun `oc login $SERVER -u $OCP_USERNAME -p $OCP_PASSWORD`\n\n</Tab>\n</Tabs>\n\nYou should now be able to access the OpenShift console:\n\n```shell\noc console\n```\n\n<InlineNotification kind=\"info\">\n\n**NOTE**: If your workshop is on Code Ready Workspaces, follow the steps in [Code Ready Workspaces Setup](/getting-started/dev-env-setup#code-ready-workspace) before logging in to the cluster.\nThe remaining steps assume this step has already been performed. If you stop and then come back later it is a good idea to re-run this step again before proceeding\n\n</InlineNotification>\n\n### 2. Create the operator development namespace\n\nBefore getting started, the development namespace/project needs to be created and prepared for the DevOps pipelines.\nThis is something that would typically happen once at the beginning of a project when a development team is formed and\nassigned to the cluster.\n\nThis step copies the common `secrets` and `configMaps` that contain the CI/CD configuration from the `tools`\nnamespace into the development namespace/project. This enables the pipelines to reference the values easily for your\nproject.\n\n```shell\noc sync ${OPERATOR_NAMESPACE}\n```\n\n### 3. Register the operator in a DevOps Pipeline\n\n1. Start the process to create a pipeline using Tekton.\n\n    ```shell\n    oc pipeline --tekton\n    ```\n\n2. The first time a pipeline is registered in the namespace, the CLI will ask for a username and **Password**/**Personal Access Token** for the Git repository that will be stored in a secret named `git-credentials`.\n\n   **Username**: Enter your GitHub user id\n\n   **Personal Access Token**: Paste your GitHub personal access token\n\n3. The CLI will attempt to determine the runtime of your repository. It should detect that it is an operator and prompt you to select `ibm-operator` pipeline or `ibm-operator-catalog` pipeline. Select `ibm-operator` pipeline.\n\n4. When registering a `Tekton` pipeline, the CLI also reads the available parameters from the pipeline and generates prompts for input. In this case, the option of scanning the built image for vulnerabilities is the only options. The scan is performed by the Vulnerability Advisor if you are using IBM Image Registry or by [Trivy](https://github.com/aquasecurity/trivy) if another image registry is used. This scan is performed in \"scan\" stage of pipeline after \"img-release\" stage.\n\n    ```shell\n    ? scan-image: Enable the pipeline to scan the image for vulnerabilities?(Y/n)\n    ```\n\n5. To skip the scan, you have type \"n\" (No). Otherwise, type \"y\" (Yes) for performing Vulnerability Scanning on the image.\n\n6. After the pipeline has been created,the command will set up a webhook from the Git host to the pipeline event listener.\n\n   **Note:** if the webhook registration step fails, it is likely because the Git credentials are incorrect or do not have enough permission in the repository.\n\n7. When the command is completed it will present options for next steps. You can use the Tekton cli commands to inspect the pipeline run that has been created and tail the log and/or navigate to the provided url to see the pipeline running from the OpenShift console.\n\n### 4. View your application pipeline\n\n1. Open the OpenShift Web Console\n\n    ```shell\n    oc console\n    ```\n\n   **OR**\n\n   ![IBM Cloud console](./images/openshiftconsole.png)\n\n2. From menu on the left switch to the **Developer** mode\n\n3. Select _dev_ project that was used for the application pipeline registration\n\n4. In the left menu, select *Pipelines*\n\nYou will see your application DevOps pipeline now starting to build and once completed will look like the image below.\n\n![OpenShift](./images/tektonpipeline.png)\n\n## Register the operator catalog pipeline\n\nThe operator catalog repository is a simple repo used to keep track of the operator bundles\nthat will be packaged together in the catalog. Even though you may start with one operator, it\nis assumed that ultimately multiple operators will be managed together in one catalog.\n\n1. Open the [operator catalog template repository](https://github.com/cloud-native-toolkit/template-operator-catalog) and\n   create a repository for the operator catalog using the template\n\n2. Copy the repository url\n\n3. Create/connect to the project for the operator development. This does not need to be the same one used for the operator build.\n\n    ```shell\n    oc sync ${OPERATOR_NAMESPACE}\n    ```\n\n4. Register the pipeline for the operator catalog\n\n    ```shell\n    oc pipeline --tekton ${GIT_URL}\n    ```\n\n## Register the catalog repository with the operator pipeline\n\nThe last step of the operator pipeline will update the operator catalog repository with the new version of the\noperator bundle that was created. This update will trigger the creation of a new version of the catalog.\n\n1. Change to the project where the operator pipeline was registered\n\n    ```shell\n    oc project ${OPERATOR_NAMESPACE}\n    ```\n\n2. Change the directory to the local clone of your operator catalog repository\n\n3. Register the url for the operator catalog repository for the operator pipeline\n\n    ```shell\n    igc git-secret olm-catalog-repo\n    ```\n\n4. Kick off the operator pipeline again to update the operator catalog repo\n\n## Configure the GitOps repo\n\n1. If you don't already have one, create a GitOps repo from the [gitops template](https://github.com/IBM/template-argocd-gitops) template\n\n2. Clone the GitOps repo to the local machine\n\n    ```shell\n    git clone ${GIT_URL}\n    ```\n\n3. Change the directory to the cloned GitOps repo\n\n4. Change to the project where the operator catalog pipeline was registered\n\n    ```shell\n    oc project ${OPERATOR_NAMESPACE}\n    ```\n\n5. Register the GitOps repo url\n\n    ```shell\n    oc gitops\n    ```\n\n6. Trigger the operator catalog pipeline build to register the catalog source in the GitOps repo\n\n7. Configure ArgoCD to deploy the `CatalogSource` into the namespace `openshift-marketplace`\n","type":"Mdx","contentDigest":"a4d43febc49071235441eeb40547f5aa","counter":1035,"owner":"gatsby-plugin-mdx"},"frontmatter":{"title":"(Advanced) Building an operator"},"exports":{},"rawBody":"---\ntitle: (Advanced) Building an operator\n---\n\nimport Globals from 'gatsby-theme-carbon/src/templates/Globals';\n\n<PageDescription>\n\nSet up DevOps pipelines to build an operator and operator catalog\n\n</PageDescription>\n\nThe <Globals name=\"shortName\" /> provides Tekton pipelines to automate the process to build and deploy operator-based\napplications. The operator pipeline supports Ansible, Go, and Helm-based operators that have been built using the Operator SDK.\nThe <Globals name=\"shortName\" /> also provides a companion Tekton pipeline to build a custom Operator Lifecycle Manager catalog\nthat simplifies deployment of the operators to a cluster.\n\nThe following steps will walk you through using the pipelines to build an operator and operator catalog and deploy them\nto a cluster.\n\n## Prerequisites\n\n### Operator SDK\n\nThe Tekton pipeline for building operators requires that the operator has been created by at least v1.0.0 of the <a href=\"https://sdk.operatorframework.io/docs/\" target=\"_blank\">Operator SDK</a>\nbut we recommend using the latest available (v1.3.0 at the time of this writing). The Operator SDK structure had a major\narchitectural change with v1.0.0 and continues to have significant improvements made with each release.\n\nIf you do not have `operator-sdk`, follow the [installation instructions](https://sdk.operatorframework.io/docs/installation/) to\nget it.\n\n## (Optional) Create your operator\n\nThese steps will walk you through building a simple operator following the Operator SDK quick-start guide. You can choose\nbetween <a href=\"https://sdk.operatorframework.io/docs/building-operators/ansible/quickstart/\" target=\"_blank\">Ansible</a>\n<a href=\"https://sdk.operatorframework.io/docs/building-operators/golang/quickstart/\" target=\"_blank\">Go</a>, or\n<a href=\"https://sdk.operatorframework.io/docs/building-operators/helm/quickstart/\" target=\"_blank\">Helm</a> quick start guides\nfor the following example.\n\n<InlineNotification>\n\n**Note:** If you already have an operator built with v1.0.0+ of the Operator SDK then you can skip to the next section.\n\n</InlineNotification>\n\nThe `Ansible` operator quick start seems to be the simplest way to get up and running quickly and exercise the Tekton\npipelines. We've included the abbreviated steps from the <a href=\"https://sdk.operatorframework.io/docs/building-operators/ansible/quickstart/\" target=\"_blank\">Ansible</a>\nquick start guide below.\n\n1. Create a directory for your operator and change to that directory\n\n    ```shell\n    mkdir memcached-operator\n    cd memcached-operator\n    ```\n1. Initialize the operator\n\n    ```shell\n    operator-sdk init --plugins=ansible --domain=example.com\n    ```\n\n    where:\n    - `--plugins` can be either `ansible`, `go`, or `helm`. If `--plugins` is not provided then it defaults to `go`\n    - `--domain` is the base domain name used for the Custom Resource Definition generated for the operator\n1. Create an API for the operator\n    ```shell\n    operator-sdk create api --group cache --version v1 --kind Memcached --generate-role\n    ```\n\n    where:\n    - `--group` is the api group for the CRD\n    - `--kind` is the resource kind for the CRD\n    - `--version` is the resource version for the CRD\n1. Generate metadata for Operator bundle\n    ```shell\n    make bundle\n    ```\n    Answer the interactive questions\n1. Create the README.md and initialize git repository\n    ```shell\n    echo \"# memcached operator\" > README.md\n    git init\n    git add .\n    git commit -m \"Initial commit\"\n    ```\n1. Create a new remote git repository on a git server such as GitHub and copy the url\n1. Push the local git repository to the remote GitHub repository\n    ```shell\n    git remote add origin ${GIT_URL}\n    git push -u origin $(git rev-parse --abbrev-ref HEAD)\n    ```\n\nAt this point you have enough of a functioning operator to try out the Tekton operator pipeline. If you want to explore\nthe operator you have created and/or enhance its capabilities, there are more detailed instructions on the [operator sdk](https://sdk.operatorframework.io/docs/building-operators/)\npage.\n\n## Register the operator pipeline\n\nThis step is similar to [deploying an application](../deploy-app).\n\n### 1. Log into your Development Cluster from the command line\n\nBefore starting, make sure you have set up your [development tools](/getting-started/dev-env-setup).\n\n<Tabs>\n<Tab label=\"Cluster managed by IBM Cloud\">\n\nLog into the cluster with `icc [cluster name|cluster nickname]`\n\n</Tab>\n<Tab label=\"OpenShift cluster\">\n\nRun `oc login $SERVER -u $OCP_USERNAME -p $OCP_PASSWORD`\n\n</Tab>\n</Tabs>\n\nYou should now be able to access the OpenShift console:\n\n```shell\noc console\n```\n\n<InlineNotification kind=\"info\">\n\n**NOTE**: If your workshop is on Code Ready Workspaces, follow the steps in [Code Ready Workspaces Setup](/getting-started/dev-env-setup#code-ready-workspace) before logging in to the cluster.\nThe remaining steps assume this step has already been performed. If you stop and then come back later it is a good idea to re-run this step again before proceeding\n\n</InlineNotification>\n\n### 2. Create the operator development namespace\n\nBefore getting started, the development namespace/project needs to be created and prepared for the DevOps pipelines.\nThis is something that would typically happen once at the beginning of a project when a development team is formed and\nassigned to the cluster.\n\nThis step copies the common `secrets` and `configMaps` that contain the CI/CD configuration from the `tools`\nnamespace into the development namespace/project. This enables the pipelines to reference the values easily for your\nproject.\n\n```shell\noc sync ${OPERATOR_NAMESPACE}\n```\n\n### 3. Register the operator in a DevOps Pipeline\n\n1. Start the process to create a pipeline using Tekton.\n\n    ```shell\n    oc pipeline --tekton\n    ```\n\n2. The first time a pipeline is registered in the namespace, the CLI will ask for a username and **Password**/**Personal Access Token** for the Git repository that will be stored in a secret named `git-credentials`.\n\n   **Username**: Enter your GitHub user id\n\n   **Personal Access Token**: Paste your GitHub personal access token\n\n3. The CLI will attempt to determine the runtime of your repository. It should detect that it is an operator and prompt you to select `ibm-operator` pipeline or `ibm-operator-catalog` pipeline. Select `ibm-operator` pipeline.\n\n4. When registering a `Tekton` pipeline, the CLI also reads the available parameters from the pipeline and generates prompts for input. In this case, the option of scanning the built image for vulnerabilities is the only options. The scan is performed by the Vulnerability Advisor if you are using IBM Image Registry or by [Trivy](https://github.com/aquasecurity/trivy) if another image registry is used. This scan is performed in \"scan\" stage of pipeline after \"img-release\" stage.\n\n    ```shell\n    ? scan-image: Enable the pipeline to scan the image for vulnerabilities?(Y/n)\n    ```\n\n5. To skip the scan, you have type \"n\" (No). Otherwise, type \"y\" (Yes) for performing Vulnerability Scanning on the image.\n\n6. After the pipeline has been created,the command will set up a webhook from the Git host to the pipeline event listener.\n\n   **Note:** if the webhook registration step fails, it is likely because the Git credentials are incorrect or do not have enough permission in the repository.\n\n7. When the command is completed it will present options for next steps. You can use the Tekton cli commands to inspect the pipeline run that has been created and tail the log and/or navigate to the provided url to see the pipeline running from the OpenShift console.\n\n### 4. View your application pipeline\n\n1. Open the OpenShift Web Console\n\n    ```shell\n    oc console\n    ```\n\n   **OR**\n\n   ![IBM Cloud console](./images/openshiftconsole.png)\n\n2. From menu on the left switch to the **Developer** mode\n\n3. Select _dev_ project that was used for the application pipeline registration\n\n4. In the left menu, select *Pipelines*\n\nYou will see your application DevOps pipeline now starting to build and once completed will look like the image below.\n\n![OpenShift](./images/tektonpipeline.png)\n\n## Register the operator catalog pipeline\n\nThe operator catalog repository is a simple repo used to keep track of the operator bundles\nthat will be packaged together in the catalog. Even though you may start with one operator, it\nis assumed that ultimately multiple operators will be managed together in one catalog.\n\n1. Open the [operator catalog template repository](https://github.com/cloud-native-toolkit/template-operator-catalog) and\n   create a repository for the operator catalog using the template\n\n2. Copy the repository url\n\n3. Create/connect to the project for the operator development. This does not need to be the same one used for the operator build.\n\n    ```shell\n    oc sync ${OPERATOR_NAMESPACE}\n    ```\n\n4. Register the pipeline for the operator catalog\n\n    ```shell\n    oc pipeline --tekton ${GIT_URL}\n    ```\n\n## Register the catalog repository with the operator pipeline\n\nThe last step of the operator pipeline will update the operator catalog repository with the new version of the\noperator bundle that was created. This update will trigger the creation of a new version of the catalog.\n\n1. Change to the project where the operator pipeline was registered\n\n    ```shell\n    oc project ${OPERATOR_NAMESPACE}\n    ```\n\n2. Change the directory to the local clone of your operator catalog repository\n\n3. Register the url for the operator catalog repository for the operator pipeline\n\n    ```shell\n    igc git-secret olm-catalog-repo\n    ```\n\n4. Kick off the operator pipeline again to update the operator catalog repo\n\n## Configure the GitOps repo\n\n1. If you don't already have one, create a GitOps repo from the [gitops template](https://github.com/IBM/template-argocd-gitops) template\n\n2. Clone the GitOps repo to the local machine\n\n    ```shell\n    git clone ${GIT_URL}\n    ```\n\n3. Change the directory to the cloned GitOps repo\n\n4. Change to the project where the operator catalog pipeline was registered\n\n    ```shell\n    oc project ${OPERATOR_NAMESPACE}\n    ```\n\n5. Register the GitOps repo url\n\n    ```shell\n    oc gitops\n    ```\n\n6. Trigger the operator catalog pipeline build to register the catalog source in the GitOps repo\n\n7. Configure ArgoCD to deploy the `CatalogSource` into the namespace `openshift-marketplace`\n","fileAbsolutePath":"/home/runner/work/ibm-garage-developer-guide/ibm-garage-developer-guide/src/pages/getting-started-day-1/build-operator/index.mdx"}}},"staticQueryHashes":["1054721580","1054721580","1317950067","1317950067","1364590287","2102389209","2102389209","223705900","3273249464","530240012","530240012","768070550"]}